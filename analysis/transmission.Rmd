---
title: "Comparing transmission"
output:
  pdf_document:
    toc: true
    toc_depth: 2
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
# output: workflowr::wflow_html
# editor_options:
#   chunk_output_type: console
```
### Aim

We aim to compare evidence for two competing explanations of the transmissibility of the variant of concern, Omicron, compared to the existing dominant variant, Delta. 

### Methods

1. Fit a model to a fixed (scaled) relationship between variants
2. Fit a model to a time-varying relationship between variants
3. Compare model fit by LOO to check the impact of allowing a flexible relationship between variants
4. Compare models scored out of sample
5. Compare to single strain model

#### Data
```{r}
library(here)
library(dplyr)
library(tidyr)
library(forecast.vocs)
library(ggplot2)
library(patchwork)
library(purrr)
library(data.table)
options(mc.cores = 4)
# Load data
source(here("code", "load-data.R"))

# Use weekly data
obs <- data.table(weekly)
timespan <- 7

# Cutoff last 3 days
# obs <- obs[date <= max_date_eng - 3]
```
Data are included from `r min(obs$date)` up to `r max(obs$date)` at a `r timespan` day resolution.

#### Parameters for the VOC
```{r}
source(here("code", "load-parameters.R"))
print(parameters)
voc_label <- "Omicron"
horizon <- 4
# model run options
output_loglik <- TRUE
adapt_delta <- 0.99
max_treedepth <- 15
refresh <- 0
show_messages <- FALSE
```

### Results

#### Model build

##### Scaled relationship between variants
```{r, message=FALSE, warning=FALSE}
forecast_scaled_fit <- forecast(obs, 
                                variant_relationship = "scaled",
                                voc_scale = parameters$voc_scale,
                                scale_r = parameters$scale_r,
                                strains = parameters$strains,
                                r_init = parameters$r_init,
                                overdispersion = parameters$overdispersion,
                                timespan = timespan,
                                horizon = horizon,
                                voc_label = voc_label,
                      # processing options
                      output_loglik = output_loglik,
                      adapt_delta = adapt_delta,
                      max_treedepth = max_treedepth,
                      refresh = refresh,
                      show_messages = show_messages)
                      
forecast_scaled <- unnest_posterior(forecast_scaled_fit)
```
Model checks:
```{r}
# Fit diagnostics
diagnose <- forecast_scaled_fit %>%
  select(samples:time) %>%
  tidyr::pivot_longer(samples:time, names_to = "diagnostic")
knitr::kable(diagnose[1:8,])

# Check LOO
loo_scaled <- forecast_scaled_fit$fit[[1]]$loo()
```

#### With a time-dependent relationship between variants
```{r, message=FALSE, warning=FALSE}
forecast_pooled_fit <- forecast(obs, 
                                variant_relationship = "pooled",
                                voc_scale = parameters$voc_scale,
                                scale_r = parameters$scale_r,
                                strains = parameters$strains,
                                r_init = parameters$r_init,
                                overdispersion = parameters$overdispersion,
                                timespan = timespan,
                                horizon = horizon,
                                voc_label = voc_label,
                      # processing options
                      output_loglik = output_loglik,
                      adapt_delta = adapt_delta,
                      max_treedepth = max_treedepth,
                      refresh = refresh,
                      show_messages = show_messages)
forecast_pooled <- unnest_posterior(forecast_pooled_fit)
```
Model checks:
```{r}
diagnose <- forecast_pooled_fit %>%
  select(samples:time) %>%
  tidyr::pivot_longer(samples:time, names_to = "diagnostic")
knitr::kable(diagnose[1:8,])

# Check LOO
loo_pooled <- forecast_pooled_fit$fit[[1]]$loo()
```

#### Compare models

##### Compare LOO

Scaled relationship:
```{r}
loo_scaled
```

Varying relationship:
```{r}
loo_pooled
```

Comparison:
```{r}
library(loo)
loo_compare(loo_scaled, loo_pooled)
```

##### Compare plots

```{r}
subtitle <- "Variant relationship: fixed (left) and varying (right)"
plots_scaled <- plot_posterior(forecast_scaled, obs)
plots_pooled <- plot_posterior(forecast_pooled, obs)

plots_join <- map(.x = 1:length(plots_scaled),
                 ~ plots_scaled[[.x]] +
                   plots_pooled[[.x]] +
                   plot_layout(nrow = 1, guides = "collect") +
                   plot_annotation(subtitle = subtitle, 
                                   theme = theme(legend.position = "bottom")))
names(plots_join) <- names(plots_scaled)
for (plot in 1:length(plots_join)) {print(plots_join[plot])}
```





