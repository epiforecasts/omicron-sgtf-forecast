---
title: "Forecast"
output: 
  html_document:
    code_folding: hide
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

### 1. Load packages and clean data
```{r}
library(here)
library(forecast.vocs)
library(ggplot2)
library(patchwork)
library(purrr)
source(here("code", "load-data.R"))
```
- Data up to week ending `r max(obs$date)` (may be incomplete).
- Daily data up to `r max_date_eng`.

### 2. Set up the parameters for the VOC
```{r}
# Prior for the growth rate modification of the VOC compared to the original.
voc_scale <- c(0.21, 0.2)

# Use a 2 strain model
strains <- 2

# Prior for initial growth rate.
r_init <- c(0, 0.25)

# Use a time scale based on generation time, rather than weekly.
scale_r <- 5.1 / 7

# Account for overdispersion
overdispersion <- TRUE

# Forecast over 4 weeks and produce standard set of quantiles
horizon <- 4
probs <- c(0.05, 0.2, 0.8, 0.95)
options(mc.cores = 4)
```

### 3. Build models

Build models using:

- A prior for a VOC growth rate relative to existing variant at mean `r voc_scale[1]` (SD `r voc_scale[2]`)

- A `r strains` strain model, with a forecast over `r horizon` weeks horizon

#### 3.1 With a scaled relationship between variants

- Run model:
```{r, message=FALSE, warning=FALSE}
forecast_scaled <- forecast(obs, variant_relationship = "scaled",
                      # any options above not specified here are package defaults
                      voc_scale = voc_scale,
                      voc_label = "Omicron",
                      scale_r = scale_r,
                      # processing options
                      adapt_delta = 0.99,
                      max_treedepth = 15,
                      refresh = 0,
                      show_messages = FALSE)
forecast_scaled <- unnest_posterior(forecast_scaled)
```
- Check model run
```{r}
diagnose <- forecast_scaled %>%
  select(samples:time) %>%
  tidyr::pivot_longer(samples:time, names_to = "diagnostic")
knitr::kable(diagnose[1:8,])
```

#### 3.2 With a time-dependent relationship between variants

- Run model:
```{r, message=FALSE, warning=FALSE}
forecast_pooled <- forecast(obs, variant_relationship = "pooled",
                      # any options above not specified here are package defaults
                      voc_scale = voc_scale,
                      voc_label = "Omicron",
                      scale_r = scale_r,
                      # processing options
                      adapt_delta = 0.99,
                      max_treedepth = 15,
                      refresh = 0,
                      show_messages = FALSE)
forecast_pooled <- unnest_posterior(forecast_pooled)
```

- Check model run
```{r}
diagnose <- forecast_pooled %>%
  select(samples:time) %>%
  tidyr::pivot_longer(samples:time, names_to = "diagnostic")
knitr::kable(diagnose[1:8,])
```

### 4. Inspect outputs

```{r}
subtitle <- "Variant relationship: fixed (left) and varying (right)"
plots_scaled <- plot_posterior(forecast_scaled, obs)
plots_pooled <- plot_posterior(forecast_pooled, obs)
plots_join <- map(.x = 1:5,
                 ~ plots_scaled[[.x]] +
                   plots_pooled[[.x]] +
                   plot_layout(nrow = 1, guides = "collect") +
                   plot_annotation(subtitle = subtitle, 
                                   theme = theme(legend.position = "bottom")))
  
plots_join[1]
plots_join[2]
plots_join[3]
plots_join[4]
plots_join[5]
```




