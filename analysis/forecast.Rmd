---
title: "Forecast"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

### Aim
- Forecast combined cases with a 2-strain fixed relationship model.

### 1. Load packages and data
```{r}
library(here)
library(dplyr)
library(tidyr)
library(forecast.vocs)
options(mc.cores = 4)
# Load data
source(here("code", "load-data.R"))
```
- Data up to week ending `r max(obs$date)` (may be incomplete).
- Daily data up to `r max_date_eng`.

### 2. Set up the parameters for the VOC
```{r}
source(here("code", "load-parameters.R"))
print(parameters)

# Use a scaled relationship
parameters$variant_relationship <- "scaled"

# Forecast over 4 weeks and produce standard set of quantiles
parameters$horizon <- 4
parameters$hub_probs <- c(0.01, 0.025, seq(0.05, 0.95, by = 0.05), 0.975, 0.99)
```

### 3. Build model

Build models using:

- A `r parameters$variant_relationship` relationship between variants

- A prior for a VOC growth rate, relative to existing variant, at mean `r parameters$voc_scale[1]` (SD `r parameters$voc_scale[2]`)

- A `r parameters$strains` strain model, with a forecast over `r parameters$horizon` weeks horizon

```{r, message=FALSE, warning=FALSE}
forecast_scaled_fit <- forecast(obs, 
                                variant_relationship = parameters$variant_relationship,
                                voc_scale = parameters$voc_scale,
                      scale_r = parameters$scale_r,
                      strains = parameters$strains,
                      r_init = parameters$r_init,
                      overdispersion = parameters$overdispersion,
                      voc_label = "Omicron",
                      horizon = parameters$horizon,
                      # processing options
                      probs = parameters$hub_probs,
                      adapt_delta = 0.99,
                      max_treedepth = 15,
                      refresh = 0,
                      show_messages = FALSE)
forecast_scaled <- unnest_posterior(forecast_scaled_fit)
```
### 4. Check model run
```{r}
# Fit diagnostics
diagnose <- forecast_scaled %>%
  select(samples:time) %>%
  tidyr::pivot_longer(samples:time, names_to = "diagnostic")
knitr::kable(diagnose[1:8,])
```

### 5. View forecast
```{r}
plot_cases(forecast_scaled)
```

### 6. Save case forecast output
```{r}
combined_forecast <- filter(forecast_scaled, 
                            value_type == "cases" & 
                              !observed &
                              type == "Combined") %>%
    select(forecast_date, 
           target_end_date = date,
           starts_with("q")) %>%
    pivot_longer(cols = starts_with("q"),
                 names_to = "quantile", values_to = "value") %>%
    mutate(quantile = as.numeric(gsub("q", "", quantile)) / 100,
           value = round(value)) %>%
  group_by(quantile) %>%
  arrange(target_end_date) %>%
  mutate(target = paste0(row_number(), " wk ahead inc case"))

write_csv(combined_forecast, here("data", "case-forecast.csv"))

print("Saved forecast for total non-VOC and VOC cases")
```
