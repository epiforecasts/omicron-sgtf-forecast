---
title: "Investigating sampling bias in S-gene target results among Covid-19 test-positive cases"
author: "Epiforecasts"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  bookdown::pdf_document2:
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, 
                      warning = FALSE, message = FALSE,
                      root.dir = here::here())
options(scipen = 1, digits = 2)
library(here)
library(forecast.vocs)
library(purrr)
library(dplyr)
library(scoringutils)
library(loo)
library(ggplot2)
library(knitr)
# get data and parameters without rebuilding model
run_model <- FALSE
source(here("sampling", "model-sampling.R"))
# both models are fit to raw or smooth (7-day MA) data. Select which to show for results
data_types <- c("data-raw", "data-smooth")
data_type <- data_types[1] # use fit to raw data
obs <- as.data.table(datasets[[data_type]])
```

### Methods

- We compared all England test-positive cases to test-positive cases with any SGT result
- We used data by `r date_type` date (figure \@ref(fig:plot-raw-data))
- Models are based on data between `r min(obs$date)` and `r max(obs$date)`. We used only the most recent three weeks of data and excluded the latest `r truncate_days` reported dates. 
- We estimated a daily growth rate and allowed weekly piecewise constant variation. We used a uniform prior for the initial growth rate advantage of SGT-result cases compared to no-SGT-result cases. 
- We estimated the transmission advantage as the difference in growth rate between the two sets of cases on a daily scale.

### Results

```{r load-forecasts}
# get model outputs
forecast_fits <- readRDS(here("sampling", data_type, "fit", "forecast-fits.rds"))[[variant_relationships]]
forecasts <- readRDS(here("sampling", data_type, "fit", "forecasts.rds"))[[variant_relationships]]

# Plot transmission advantage
advantage <- forecasts %>%
  filter(value_type == "model" & variable == "avg_voc_advantage") %>%
  select(variant_relationship, variable, clean_name, exponentiated:ess_bulk)

voc_scaled <- plot_voc_advantage(forecasts) +
  labs(y = "Transmission advantage among SGT-tested", x = NULL)
ggsave(here("sampling", data_type, "figures", "voc_advantage.png"), voc_scaled)

```

- On average, `r round(mean(obs$share_voc, na.rm=T)*100)`% cases had an SGT result. 
- We found a median advantage for SGT-result cases of `r exp(advantage$median)` (95% credible interval `r exp(advantage$q5)` - `r exp(advantage$q95)`), scaled against cases without an SGT result. 
- We also estimated the growth rate (figure \ref{fig:plot-growth}).

```{r plot-growth, fig.cap="Growth rate for all cases (Combined), those with an S-gene target result (SGT-result) and those without"}
growth_scaled <- plot_growth(forecasts) +
  labs(y = "Growth rate", x = NULL)
ggsave(here("sampling", data_type, "figures", "growth_rate.png"), growth_scaled)
growth_scaled
```

\newpage

### Raw data {-}

```{r plot-raw-data, fig.cap="Raw data"}
plot(plot_daily_cases)
```
