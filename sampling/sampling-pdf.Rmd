---
title: "Sampling bias in S-gene target data"
author: "Epiforecasts"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, 
                      warning = FALSE, message = FALSE,
                      root.dir = here::here())
options(scipen = 1, digits = 2)
library(here)
library(forecast.vocs)
library(purrr)
library(dplyr)
library(scoringutils)
library(loo)
library(ggplot2)
# get data and parameters without rebuilding model
run_model <- FALSE
source(here("code", "model-sampling.R"))
```
### Background
Among all cases that are test-positive, some are tested for the S-gene target (SGT). A successful test for the S-gene target can give either a failure or a positive result. The proportion of SGT cases that result in SGT-Failure is a useful proxy for the proportion of the Omicron variant in comparison to the Delta variant. 

The ability to provide an SGT result is not uniform across all test-positive cases. If cases with an SGT result differ from cases which cannot be tested for SGT, this would create a bias in comparisons of Omicron compared to Delta. For example, test-positive cases with an SGT result may be a result of sampling contacts of a known case with Omicron variant, which are also sent in a batch to a lab which is able to process SGT results. 

We can compare these two groups in a two-strain branching process model. If the transmissibility advantage for cases with an SGT result is not centred on 100% then this might indicate sampling bias.

### Methods

Data

- We used data for all England test-positive cases (pillar 1 and 2 of the UK testing strategy). 
- We used only the most recent three weeks of data, between `r min(obs$date)` and `r max(obs$date)`.

Model

- We built a two-strain model to compare sampling of all test-positive cases compared to test-positive cases with any confirmed S-gene target (SGT) result. 
- We allowed a weekly piecewise constant variation in growth rate.
- We used a uniform prior for the growth rate advantage of SGT-result cases compared to no-SGT-result cases.


### Results {-}
```{r load-forecasts}
# get model outputs
forecast_fits <- readRDS(here("sampling", "fit", "forecast-fits.rds"))
forecasts <- readRDS(here("sampling", "fit", "forecasts.rds"))
```

- Transmission advantage

```{r plot-voc-advantage, fig.cap="The transmission advantage"}
# Plot transmission advantage
advantage <- map(forecasts,
                 ~ filter(.x, value_type == "model" &
                            variable == "avg_voc_advantage") %>%
                   select(variant_relationship, variable, clean_name, 
                          exponentiated:ess_bulk))

voc_scaled <- plot_voc_advantage(forecasts$scaled) +
  labs(y = "Transmission advantage among SGTF-tested", x = NULL)
ggsave(here("sampling", "figures", "voc_advantage.png"), voc_scaled)

voc_scaled

```


- Growth rate


```{r plot-growth-rt, fig.cap="The growth rate"}
growth_scaled <- plot_growth(forecasts$scaled) +
  labs(y = "Growth rate", x = NULL)
ggsave(here("sampling", "figures", "growth_rate.png"), growth_scaled)
growth_scaled

```

- Cases (log)


```{r plot-cases, fig.cap="Cases"}
cases_scaled <- plot_cases(forecasts$scaled, obs) +
  labs(x = NULL)
ggsave(here("sampling", "figures", "cases.png"), cases_scaled)
cases_scaled

```


### Discussion {-}

adapt 2-strain model to look for sampling bias:
use tested or not instead of strain

growth in non-tested should be same as in tested
growth rate always biased up since testing contacts
output Rt


transmission adv = simple diff in growth rate * scaling (5.1d)
