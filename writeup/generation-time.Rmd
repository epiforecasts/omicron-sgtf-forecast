---
title: "Joint estimation of the test to test distributions as a proxy for generation interval distributions for the Omicron and Delta variants in England using S-Gene Target Status"
subtitle: "Summary report"
author: Sam Abbott (1), Katharine Sherratt (1), Sebastian Funk (1)
bibliography: library.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    toc_depth: 4
    includes:
      before_body: header.html
      after_body:  footer.html
  pdf_document:
    extra_dependencies: ["float"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE,
                      warning = FALSE, message = FALSE,
                      root.dir = here::here(),
                      fig.width = 12, fig.height = 9)
library(here)
library(forecast.vocs)
library(dplyr)
library(loo)
library(scoringutils)
library(knitr)
library(data.table)
library(ggplot2)
library(scales)
library(dplyr)
library(here)
library(readr)
library(data.table)

# load functions
source(here("R", "load-local-data.R"))
source(here("R", "plot-daily-cases.R"))
```

```{r setup-dates}
date_data_start <- as.Date("2021-11-23")
date_gt_start <- as.Date("2021-12-01")
date_forecast_start <- as.Date("2021-12-23")
```

1. Centre for the Mathematical Modelling of Infectious Diseases, London School of Hygiene & Tropical Medicine, London WC1E 7HT, United Kingdom

## Introduction

Since being highlighted by scientists in South Africa Omicron has spread rapidly globally. Using initial South African data, it has been estimated that Omicron may be both more transmissible and have greater immune escape than the previously dominant Delta variant [@pearson-omicron]. 

In this work, we use S-gene target failure (SGTF) as a proxy of variant status combined with reported case counts to explore the evidence for changes in transmission advantage over time for the Omicron variant. If present this could indicate the impact of immune escape, sampling bias in SGTF data or differences in the populations within which the variants are circulating. We also report estimates for growth rates by variant and overall, case counts overall and by variant for a 14 day forecast window assuming constant future growth, the date at which Omicron will become dominant in England and in each UKHSA region, and the estimated cumulative percentage of the population with a reported Omicron case. We also explore the potential for bias in S-gene target sampling by comparing cases that have a reported SGTF status to cases with an unknown SGTF status. 

## Methods

### Data

We use S-gene status by specimen date sourced from UKHSA as a direct proxy for the Omicron variant with a target failure indicating a case has the Omicron variant. We augment this data with reported cases counts by date of specimen truncated by two days to account for delayed reporting. Data was available for England and for UKHSA region from both sources.

### Growth rate estimation

We consider two autoregressive models with different assumptions about the relationship between growth rates for Omicron and non-Omicron cases. Both models estimate expected cases for each variant as a combination of expected cases from the previous day and the exponential of the log growth rate. The growth rate is then itself modelled as a differenced AR(1) process. 

For the first model variants are assumed to have growth rates related by a fixed scaling (described from now on as the scaled model). In this model, variant growth rates then share a single differenced AR(1) process meaning that they vary over time in the same way. This model assumes that variants differ only due to a transmission advantage and that there are no time-varying biases in the reported data.

In the second model, we relax the assumption that variants co-vary using a vector autoregression structure which assume that the 1st differences of the variant growth rates are drawn from a multivariate normal distribution. This model formulation can account for variant differences other than a transmission advantage and can also better handle time-varying biases in data sources. Crucially, in the absence of evidence that variants do not co-vary, it reduces to the co-varying model.

For both models, we fit jointly to reported cases and SGTF data assuming a negative binomial and beta-binomial observation model respectively. Day of the week reporting periodicty for case counts is captured using a random effect fo r the day of the week. We initialise both models by fitting to a week of case only data where the Omicron variant is assumed to not be present (from the 17th of November to the 22nd).

A full description of the models described here can be found in the documentation for the [`forecast.vocs` R package](https://epiforecasts.io/forecast.vocs/) [@forecast.vocs].

```{r load-regional-growth}
# get regional estimation date
regional_date <- as.Date("2022-01-06")

# load case data
daily <- load_local_data(regional_date) %>%
  filter(date <= date_forecast_start)

# load posterior estimates
sgtf <- load_results(regional_date)

sgtf_posterior <- sgtf$posterior[
  variant_relationship == "correlated"
][date <= date_forecast_start]

# load growth estimates
region_growth <- load_growth(
  regional_date, min_date = date_gt_start, max_date = date_forecast_start
)
region_growth <- region_growth[!(region %in% "England")]
```

### Generation time and transmission advantage estimation

```{r load-generation-time-estimates}
posterior_summary <- fread(
  here::here("data", "retrospective", "posterior_summary.csv")
)
posterior_predictions <- fread(
  here::here("data", "retrospective", "posterior_predictions.csv")
)
```

### Statistical Inference

We first visualised our combined data sources (cases by specimen date and SGTF status by specimen date). We then fit both models separately to data for England and to each UKHSA region. Using these model fits we report posterior estimates from the best fitting model for the following summary statistics of epidemiological interest: growth rates by variant and overall, the time-varying transmission advantage for the Omicron variant, case counts overall and by variant for a 14 day forecast window assuming constant future growth, the date at which Omicron will become dominant in England and in each UKHSA region, and the estimated cumulative percentage of the population with a reported Omicron case. 

We explored the potential for bias in S-gene target sampling by comparing cases that have a reported SGTF status to cases with an unknown SGTF status. We fit the correlated model to case counts and S-gene tested status and reported the apparent transmission advantage for those with a S-gene status over time. Any variation in this metric from 100% may be interpreted as indicating biased sampling of those with known S-gene status, which may bias our main results.

### Implementation

All models were implemented using the [`forecast.vocs` R package](https://epiforecasts.io/forecast.vocs/) [@R; @forecast.vocs] and fit using `stan` [@stan] and `cmdstanr` [@cmdstanr]. Each model was fit using 2 chains with each chain having 1000 warmup steps and 2000 sampling steps. Convergence was assessed using the Rhat diagnostic [@stan]. 


## Limitations


* SGTF may be an imperfect proxy for Omicron. We make no adjustment for the background rate of SGTF observed for Delta or other factors that might lead to SGTF, or a confirmed detected S-gene observed with Omicron.

* The public case data used here does not include known reinfections. If the proportion of infections that are reinfections varies over time and between variants then this could affect our estimates.

* Our analysis is based on reported case counts augmented with SGTF data. Growth rates estimated from reported case counts may be biased during periods when changes in testing practice occur or when available testing is at capacity.

* We reported the log growth rate approximation to the growth rate. This approximation becomes less valid for high absolute growth rates.

* Our model only estimates an overall transmission advantage. We do not attempt to distinguish between "intrinsic" transmissibility and immune escape, a combination of which is likely to be underlying any sustained differences in growth rate.

* Our estimates are at the national scale stratified by 5 year age group or UKHSA region scale. There may be additional variation within these  grouups that these estimates cannot capture.

## Results 

### Data description

```{r data, fig.cap = "Daily cases in England and by UKHSA region, with S-gene target result (failed, confirmed detected, or unknown), and centred 7-day moving average starting from the 23rd of November 2021 and including data up to the 23rd of December 2021 (dotted line). Source: UKHSA and coronavirus.gov.uk; data by specimen date."}
plot_daily_cases(
  daily, truncate_date = date_forecast_start, caption = "",
  start_date = date_data_start, smooth_total = TRUE
)
```

### Growth rate of reported cases overall, with the Omicron variant, and not with the Omicron variant

#### Over time

```{r growth, fig.cap = "Estimates of the time-varying daily growth rate for England and by UKHSA region (using the log scale approximation) for reported cases overall, cases with the Omicron variant, and non-Omicron cases. Growth rates are assumed to be piecewise constant with potential changes every 3 days. Growth rates are assumed to be constant beyond the forecast horizon (vertical dashed line). 90% and 60% credible intervals are shown."}
plot_growth(sgtf_posterior) +
  facet_wrap(~ region)
```

#### Omicron versus Delta

```{r plot-o-vs-d-growth, fig.cap = "Estimates of the time-varying daily growth rate for each UKHSA region for cases with the Omicron variant, and non-Omicron cases. Point size has been used to represent the uncertainty of each estimate (though it does not correspond to a meaningful credible interval). The dashed grey line indicates the expected relationship between variants if they differ onyl by a transmission advantage. The solid grey line indicates the observed overall relationship between variants, the slope of this line approximates the ratio between generation time means. The region specific lines show how this relationship differs between regions."}
piv_growth <- region_growth %>%
  pivot_wider(id_cols = c("region", "date"),
              names_from = "type", values_from = c("mean", "sd"))
min_nomicron <- abs(min(piv_growth[["mean_non-Omicron"]]))
    
ggplot(piv_growth) +
  aes(y = mean_Omicron, x = .data[["mean_non-Omicron"]], size = sd_Omicron,
      col = region
  ) +
  scale_color_brewer(palette = "Paired") +
  geom_abline(slope = 1, intercept = min_nomicron, col = "#777575",
              linetype = 2, size = 1.5) +
  geom_smooth(method = "lm", formula = y ~ x,
              se = FALSE, alpha = 0.2) +
  geom_smooth(col = "#777575", method = "lm", formula = y ~ x,
              se = FALSE, size = 1.5, alpha = 0.3, linetype = 1) +
  geom_point(alpha = 0.3) +
  scale_size(guide = "none") +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x = "Delta daily growth rate", y = "Omicron daily growth rate",
       col = "UKHSA region")
```

### Generation time and transmission advantage estimates

#### Overall

### Posterior predictions


#### Overall
## References
