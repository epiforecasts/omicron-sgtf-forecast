---
title: "Real-time estimation of the time-varying transmissibility advantage of Omicron in England using S-Gene Target Status as a Proxy"
subtitle: "Summary report"
author: Katharine Sherratt, Sam Abbott, Sebastian Funk
bibliography: library.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    toc_depth: 4
    includes:
      before_body: header.html
      after_body:  footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, 
                      warning = FALSE, message = FALSE,
                      root.dir = here::here(),
                      fig.width = 9, fig.height = 9)
options(digits = 1)
library(here)
library(forecast.vocs)
library(dplyr)
library(loo)
library(scoringutils)
library(knitr)
library(data.table)
```

```{r load-results}
# load packages
library(ggplot2)
library(scales)
library(dplyr)
library(here)
library(readr)

# load functions
source(here("R", "load-local-data.R"))
source(here("R", "plot-daily-cases.R"))
source(here("R", "plot-omicron-95.R"))
source(here("R", "plot-cumulative-percent.R"))

growth_type <- "growth_from_rt" # or "growth" the default returned by forecast.vocs

# get latest date
# date_latest <- get_latest_date()
date_latest <- as.Date("2021-12-19")

# load data
daily <- load_local_data(date_latest)

# load results
sgtf <- load_results(date_latest, growth_type = "growth_from_rt")
voc_frac <- simplify_posterior(sgtf$posterior, value_type = "voc_frac") 
cases <- simplify_posterior(sgtf$posterior, value_type = "cases") %>%
  filter(type == "Omicron")

bias <- load_results(date_latest, type = "bias")
# set up dates
date_data_start <- min(sgtf$data$date)
date_forecast_start <- max(sgtf$data$date)
date_forecast_end <- max(sgtf$posterior$date, na.rm = TRUE)
```
### Summary

```{r summary}
# Summary plot:
# omicron transmission advantage
advantage <- simplify_posterior(sgtf$posterior, value_type = "voc_advantage") %>%
  mutate(value_type = "Transmission advantage of Omicron")

# growth
growth <- simplify_posterior(sgtf$posterior, value_type = "growth")

# cumulative pop
cumpercent <- simplify_posterior(sgtf$posterior, value_type = "cases") %>%
  filter(type == "Omicron")
cumpercent <- plot_cumulative_percent(cases = cases,
                                      forecast_start = date_forecast_start,
                                      data_start = date_data_start)$data %>%
  mutate(value_type = "Omicron cumulative % population",
         region = as.character(region))

# bias
sampling <- simplify_posterior(bias$posterior, value_type = "voc_advantage") %>%
  mutate(value_type = "Transmission advantage of S-gene result")

# join --------------------------------------------------------------------
region_factor <- unique(sgtf$posterior$region)
names(region_factor) <- region_factor

summary_data <- bind_rows(advantage, growth, cumpercent, sampling) %>%
  filter(date == date_latest & !type %in% c("Combined", "non-Omicron")) %>%
  select(region, value_type, type, median, q5, q95)

summary_plot <- summary_data %>%
  ggplot(aes(y = region)) +
  geom_linerange(aes(xmin = q5, xmax = q95)) +
  geom_point(aes(x = median)) +
  facet_wrap(~ value_type, scales = "free_x") +
  labs(y = NULL, x = NULL)

forecast.vocs::plot_theme(summary_plot) +
  scale_x_continuous()

# # date at which Omicron accounts for 95% all cases
# voc_frac <- simplify_posterior(sgtf$posterior, value_type = "voc_frac")
# voc_frac <- plot_omicron_95(voc_frac = voc_frac,
#                             forecast_start = date_forecast_start,
#                             forecast_end = date_forecast_end)$data %>%
#   rename_with(~gsub(pattern = "q_", replacement = "", .))

```

## Background

## Methods

## Limitations

## Results 

### Data description

```{r data, fig.cap = "Daily cases in England and by UKHSA region, with S-gene target result (failed, confirmed detected, or unknown), and centred 7-day moving average up to date of data truncation (dotted line)."}
plot_daily_cases(
  daily, caption = "Source: UKHSA and coronavirus.gov.uk; data by specimen date",
  truncate_date = Sys.Date() - 1, start_date = "2021-11-23", smooth_total = TRUE
)
```

### Model comparison

```{r compare-score}
scores <- janitor::clean_names(
  select(sgtf$loo, -forecast_date), case = "sentence"
)
kable(scores)
```

### Growth rate of S-gene positive and negative cases

```{r growth}
plot_growth(
  as.data.table(sgtf$posterior)[variant_relationship == "correlated"]
) +
  facet_wrap(~ region)
```

### Proportion of cases with SGTF

```{r, voc-frac}
plot(
  sgtf$posterior, as.data.table(sgtf$data), type = "voc_frac",
  fill = variant_relationship, voc_label = "Omicron variant"
) +
  facet_wrap(~ region)
```

#### Date at which SGTF accounts for 95% all cases
```{r omicron-95}
plot_omicron_95(voc_frac = voc_frac, 
                forecast_start = date_forecast_start, 
                forecast_end = date_forecast_end)
```

### Transmission advantage of the cases with SGTF


```{r, voc-advantage}
plot(
  sgtf$posterior, type = "voc_advantage",
  fill = variant_relationship, group = variant_relationship,
  voc_label = "Omicron variant"
) +
  facet_wrap(~ region)
```

### Posterior predictions of cases

```{r, cases}
plot(
  sgtf$posterior, as.data.table(sgtf$data), type = "cases"
) +
  facet_grid(region ~ variant_relationship, scales = "free_y")
```
#### Cumulative cases since `r format(date_data_start, "%d %B %y")` by population
```{r cumulative-population}
plot_cumulative_percent(cases = cases, 
                        forecast_start = date_forecast_start,
                        data_start = date_data_start)
```

### Evidence of sampling bias in S-gene target results among Covid-19 test-positive cases

```{r, bias-advantage}
plot(bias$posterior, type = "voc_advantage") +
  labs(y = "Transmission advantage of cases with a reported S gene
            status versus those without") +
  facet_wrap(~ region)
```

## References
