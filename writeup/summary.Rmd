---
title: "Real-time estimation of the time-varying transmissibility advantage of Omicron in England using S-Gene Target Status as a Proxy"
subtitle: "Summary report"
author: Katharine Sherratt, Sam Abbott, Sebastian Funk
bibliography: library.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    toc_depth: 4
    includes:
      before_body: header.html
      after_body:  footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, 
                      warning = FALSE, message = FALSE,
                      root.dir = here::here(),
                      fig.width = 9, fig.height = 9)
options(digits = 3)
library(here)
library(forecast.vocs)
library(dplyr)
library(loo)
library(scoringutils)
library(knitr)
library(data.table)
```

```{r load-results}
# load packages
library(ggplot2)
library(scales)
library(dplyr)
library(here)
library(readr)

# load functions
source(here("R", "load-local-data.R"))
source(here("R", "plot-daily-cases.R"))
source(here("R", "plot-summary.R"))
source(here("R", "plot-omicron-95.R"))
source(here("R", "plot-cumulative-percent.R"))

growth_type <- "growth_from_rt" # or "growth" the default returned by forecast.vocs

# get latest date
date_latest <- get_latest_date()

# load data
daily <- load_local_data(date_latest)

# load results
sgtf <- load_results(date_latest, growth_type = "growth_from_rt")
voc_frac <- simplify_posterior(sgtf$posterior, value_type = "voc_frac") 
sgtf_cases <- simplify_posterior(sgtf$posterior, 
                            value_type = "cases", variant_type = "Omicron")
bias <- load_results(date_latest, type = "bias")
# set up dates
date_data_start <- min(sgtf$data$date)
date_forecast_start <- max(sgtf$data$date)
date_forecast_end <- max(sgtf$posterior$date, na.rm = TRUE)
```
### Summary

```{r summary}
# Summary plot
summary_plot <- plot_summary(sgtf, bias, sgtf_cases, 
                             date_forecast_start, date_data_start)
plot(summary_plot)
```

## Background

## Methods

## Limitations

## Results 

### Data description

```{r data, fig.cap = "Daily cases in England and by UKHSA region, with S-gene target result (failed, confirmed detected, or unknown), and centred 7-day moving average up to date of data truncation (dotted line)."}
plot_daily_cases(
  daily, caption = "Source: UKHSA and coronavirus.gov.uk; data by specimen date",
  truncate_date = Sys.Date() - 1, start_date = "2021-11-23", smooth_total = TRUE
)
```

### Model comparison

```{r compare-score}
scores <- janitor::clean_names(
  select(sgtf$loo, -forecast_date), case = "sentence"
)
kable(scores, caption = "LOO cross validation, comparing performance improvement from a correlated time-varying relationship compared to a fixed variant relationship")
```

### Growth rate of S-gene positive and negative cases

```{r growth, fig.cap = "Daily growth rate for Omicron, non-Omicron, and combined cases, by variant in England and by UKHSA region, estimated and forecast (after dashed line). Growth rate estimated with 3 day step"}
plot_growth(
  as.data.table(sgtf$posterior)[variant_relationship == "correlated"]
) +
  facet_wrap(~ region) +
  labs(x = NULL)
```

### Proportion of cases with SGTF

```{r, voc-frac, fig.cap = "Percentage cases with Omicron variant, by model of variant relationship (scaled or time-varying correlated), for England and UKHSA region"}
plot(
  sgtf$posterior, as.data.table(sgtf$data), type = "voc_frac",
  fill = variant_relationship, voc_label = "Omicron variant"
) +
  facet_wrap(~ region) +
  labs(x = NULL, fill = "Variant relationship")
```

#### Date at which SGTF accounts for 95% all cases
```{r omicron-95, fig.cap = "Date at which Omicron accounts for 95% case notifications using a time-varying correlated model of the relationship between variants, in England and by UKHSA region. The dashed line indicates the start of the forecast period"}
plot_omicron_95(voc_frac = voc_frac, 
                forecast_start = date_forecast_start, 
                forecast_end = date_forecast_end)
```

### Transmission advantage of the cases with SGTF


```{r, voc-advantage, fig.cap = "Transmission advantage of Omicron, using models with both fixed and time-varying relationship between variants, in England and by UKHSA region"}
plot(
  sgtf$posterior, type = "voc_advantage",
  fill = variant_relationship, group = variant_relationship,
  voc_label = "Omicron variant"
) +
  facet_wrap(~ region) +
  labs(x = NULL, fill = "Variant relationship")
```

### Posterior predictions of cases

```{r, cases, fig.cap = "Estimated and forecast (after dashed line) cases for scaled and time-varying correlated models of the variant relationship, by England and UKHSA region"}
plot(
  sgtf$posterior, as.data.table(sgtf$data), type = "cases"
) +
  facet_grid(region ~ variant_relationship, scales = "free_y") +
  labs(x = NULL, fill = "Variant type")
```
#### Cumulative cases since `r format(date_data_start, "%d %B %y")` by population
```{r cumulative-population, fig.cap = "Cumulative Omicron cases as a % regional population since mid-November"}
plot_cumulative_percent(cases = sgtf_cases, 
                        forecast_start = date_forecast_start,
                        data_start = date_data_start)
```

### Evidence of sampling bias in S-gene target results among Covid-19 test-positive cases

```{r, bias-advantage, fig.cap = "Potential sampling bias among testing Covid-19 positive cases, in terms of transmission advantage where 100% indicates equivalence between reported cases with an S-gene target result and those without"}
plot(bias$posterior, type = "voc_advantage") +
  labs(y = "Transmission advantage of cases with a reported S gene
            status versus those without") +
  facet_wrap(~ region) +
  labs(x = NULL)
```

## References
