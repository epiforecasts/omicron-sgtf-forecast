---
title: "Real-time estimation of the time-varying transmissibility advantage of Omicron in England using S-Gene Target Status as a Proxy"
subtitle: "Summary report"
author: Katharine Sherratt, Sam Abbott, Sebastian Funk
bibliography: library.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    toc_depth: 4
    includes:
      before_body: header.html
      after_body:  footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, 
                      warning = FALSE, message = FALSE,
                      root.dir = here::here(),
                      fig.width = 9, fig.height = 9)
options(digits = 1)
library(here)
library(forecast.vocs)
library(dplyr)
library(loo)
library(scoringutils)
library(knitr)
library(data.table)
```

```{r load-results}
# load packages
library(ggplot2)
library(scales)
library(dplyr)
library(here)
library(readr)

# load functions
source(here("R", "load-local-data.R"))
source(here("R", "plot-daily-cases.R"))
source(here("R", "plot-omicron-95.R"))
source(here("R", "plot-cumulative-percent.R"))

# get latest date
date_latest <- get_latest_date()

# load data
daily <- load_local_data(date_latest)

# load results
sgtf <- load_results(date_latest)
bias <- load_results(date_latest, type = "bias")

# get cases from correlated model
cases <-  simplify_posterior(sgtf$posterior, value_type = "cases")

# get VOC fraction from correlated model
voc_frac <- simplify_posterior(sgtf$posterior, value_type = "voc_frac") 

# set up dates
date_data_start <- min(sgtf$data$date)
date_forecast_start <- max(sgtf$data$date)
date_forecast_end <- max(cases$date)
```

## Background

## Methods

## Limitations

## Results 

### Summary

```{r summary}
# Summary plot:
# - date at which omicron is 95% cases 
# - 
```

### Data description

```{r data, fig.cap = "Daily cases in England and by UKHSA region, with S-gene target result (failed, confirmed detected, or unknown), and centred 7-day moving average up to date of data truncation (dotted line)."}
plot_daily_cases(
  daily, caption = "Source: UKHSA and coronavirus.gov.uk; data by specimen date",
  truncate_date = Sys.Date() - 1, start_date = "2021-11-23", smooth_total = TRUE
)
```

### Model comparison

```{r compare-score}
scores <- janitor::clean_names(
  select(sgtf$loo, -forecast_date), case = "sentence"
)
kable(scores)
```

### Growth rate of S-gene positive and negative cases

```{r growth}
plot_growth(
  as.data.table(sgtf$posterior)[variant_relationship == "correlated"]
) +
  facet_wrap(~ region)
```

### Proportion of cases with SGTF

```{r, voc-frac}
plot(
  sgtf$posterior, as.data.table(sgtf$data), type = "voc_frac",
  fill = variant_relationship, voc_label = "Omicron variant"
) +
  facet_wrap(~ region)
```

### Transmission advantage of the cases with SGTF


```{r, voc-advantage}
plot(
  sgtf$posterior, type = "voc_advantage",
  fill = variant_relationship, group = variant_relationship,
  voc_label = "Omicron variant"
) +
  facet_wrap(~ region)
```

### Posterior predictions of cases

```{r, cases}
plot(
  sgtf$posterior, as.data.table(sgtf$data), type = "cases"
) +
  facet_grid(region ~ variant_relationship, scales = "free_y")
```

### Evidence of sampling bias in S-gene target results among Covid-19 test-positive cases

```{r, bias-advantage}
plot(bias$posterior, type = "voc_advantage") +
  labs(y = "Transmission advantage of cases with a reported S gene
            status versus those without") +
  facet_wrap(~ region)
```

### Date at which Omicron accounts for 95% all cases
```{r omicron-95}
plot_omicron_95(voc_frac = voc_frac, 
                forecast_start = date_forecast_start, 
                forecast_end = date_forecast_end)
```

### Cumulative cases since `r format(date_data_start, "%d %B %y")` by population
```{r cumulative-population}
plot_cumulative_percent(cases = cases, 
                        forecast_start = date_forecast_start,
                        data_start = date_data_start)
```

## References
