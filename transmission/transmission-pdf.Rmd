---
title: "Exploring the transmission advantage of Omicron in England"
author: "Epiforecasts"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: bookdown::pdf_document2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, 
                      warning = FALSE, message = FALSE,
                      root.dir = here::here())
options(scipen = 1, digits = 2)
library(here)
library(forecast.vocs)
library(dplyr)
library(scoringutils)
# get data and parameters without rebuilding model
source(here("code", "build-models.R"))
```

### Background {-}

We aimed to assess competing explanations of the transmission advantage of a variant of concern (VoC), Omicron, compared to the existing dominant strain, Delta, in England. We explored the likelihood of increased transmissibility compared to immune escape, using S-gene target failure as a proxy for infection with Omicron.

We use a model framework where we vary only the relationship between variants while holding all other parameters constant. We compare leave-one-out validation among the models and explore the estimated transmission advantage.

### Methods {-}

We used case data from England. This includes all cases tested by PCR test following symptom onset and a positive lateral flow test result. For a varying proportion of these cases, PCR test results included information on S-gene target. We used S-gene target negativity as a proxy for the Omicron variant. We excluded data before `r start_date`, to reduce overfitting to stochastic imports. Data are included up to `r max(obs$date)` and modelled at a `r timespan` day resolution. All dates are by specimen date.

We used the `forecast.vocs` package^[2021, Sam Abbott, forecast.vocs: Forecast case and sequence notifications using variant of concern strain dynamics, DOI:10.5281/zenodo.5559016] to model a two-strain branching process, including strain specific auto-regressive AR(1) variation, and a beta binomial observation process for the S-gene target status data. We used a weakly informative prior for a transmission advantage for the VoC vs non-VoC cases of mean `r parameters$voc_scale[1]` (standard deviation `r parameters$voc_scale[2]`), based on early work from South Africa^[2021-12-03, Carl Pearson and others, "Omicron spread in South Africa", Epidemics8]. 

We defined the relationship between variants as either fixed or pooled. The fixed relationship meant the VoC differed only by its transmissibility to the non-VOC strain, with any variation over time shared between strains. The pooled relationship allowed the VoC to differ with dependence determined from the data. See Appendix for full model details.

We tested the difference between the two models by comparing out of sample predictive fit using leave-one-out cross-validation with Pareto smoothed importance sampling, and model scoring.

### Results {-}
```{r load-forecasts}
# get model outputs
forecast_fits <- readRDS(here("output", "forecast-fits.rds"))
forecasts <- readRDS(here("output", "forecasts.rds"))
```

#### Transmission advantage {-}

```{r plot-voc-advantage, fig.cap="The transmission advantage of Omicron, modelled in a fixed relationship to Delta (left) and a time-varying relationship (right)."}
# Plot VOC advantage
advantage <- map(forecasts,
                 ~ filter(.x, value_type == "model" &
                            variable == "avg_voc_advantage") %>%
                   select(variant_relationship, variable, clean_name, 
                          exponentiated:ess_bulk))

voc_scaled <- plot_voc_advantage(forecasts$scaled) +
  labs(subtitle = "Fixed variant relationship", 
       y = "Transmission advantage for Omicron", x = NULL)
voc_pooled <- plot_voc_advantage(forecasts$pooled) +
  labs(subtitle = "Pooled variant relationship", 
       y = NULL, x = NULL)

plot_advantage <- voc_scaled +
    voc_pooled +
  plot_layout(nrow = 1, guides = "collect") +
  plot_annotation(theme = theme(legend.position = "bottom"))
ggsave(here("output", "voc_advantage.png"), plot_advantage)

plot_advantage

```

Transmission advantage is shown where 100% is equivalent to the current dominant strain, Delta (figure \@ref(fig:plot-voc-advantage)). Both models indicated a stronger transmission advantage for Omicron. 

As a baseline, we assumed a fixed relationship between variants to model transmission advantage without variation over time. Here, estimated Omicron advantage is `r advantage[["scaled"]][["median"]]` (95% credible interval `r advantage[["scaled"]][["q5"]]` - `r advantage[["scaled"]][["q95"]]`). In comparison, we used a pooled relationship drawn from data to allow transmission advantage to vary over time. In this setting, the apparent transmission advantage of Omicron rose over time before stabilising at a higher transmission advantage compared to Delta. On average over time, we found an Omicron advantage of `r advantage[["pooled"]][["median"]]` (95% CrI `r advantage[["pooled"]][["q5"]]` - `r advantage[["pooled"]][["q95"]]`).

#### Growth rate and reproduction number {-}


```{r plot-growth-rt, fig.cap="The growth rate and reproduction number of Omicron, modelled in a fixed relationship to Delta (left) and a time-varying relationship (right)."}
growth_scaled <- plot_growth(forecasts$scaled) +
  labs(subtitle = "Fixed variant relationship", 
       y = "Growth rate", x = NULL)
rt_scaled <- plot_rt(forecasts$scaled) +
  labs(y = "Rt", x = NULL)

growth_pooled <- plot_growth(forecasts$pooled) +
  labs(subtitle = "Pooled variant relationship", 
       y = NULL, x = NULL)
rt_pooled <- plot_rt(forecasts$pooled) +
  labs(y = NULL, x = NULL)

plot_growth_rt <- growth_scaled + growth_pooled +
  rt_scaled + rt_pooled +
  plot_layout(nrow = 2, guides = "collect") +
  plot_annotation(theme = theme(legend.position = "bottom"))
ggsave(here("output", "growth_rt.png"), plot_growth_rt)
plot_growth_rt

```

See figure \@ref(fig:plot-growth-rt).

#### Cases attributable to Omicron {-}


```{r plot-voc-frac, fig.cap="Fraction of cases attributable to Omicron, modelled in a fixed relationship to Delta (left) and a time-varying relationship (right)."}
voc_frac_scaled <- plot_voc_frac(forecasts$scaled) +
  labs(subtitle = "Fixed variant relationship", 
       y = "% overall cases with Omicron", x = NULL)
voc_frac_pooled <- plot_voc_frac(forecasts$pooled) +
  labs(subtitle = "Pooled variant relationship", 
       y = NULL, x = NULL)

plot_frac <- voc_frac_scaled +
  voc_frac_pooled +
  plot_layout(nrow = 1, guides = "collect") +
  plot_annotation(theme = theme(legend.position = "bottom"))
ggsave(here("output", "voc_frac.png"), plot_frac)
plot_frac

``` 

See figure \@ref(fig:plot-voc-frac).

#### Cases {-}


```{r plot-cases, fig.cap="Weekly cases shown on a log scale, modelled in a fixed relationship to Delta (left) and a time-varying relationship (right)."}
# Plot cases
cases_scaled <- plot_cases(forecasts$scaled, obs, log = TRUE) +
  labs(subtitle = "Fixed variant relationship", x = NULL)
cases_pooled <- plot_cases(forecasts$pooled, obs, log = TRUE) +
  labs(subtitle = "Pooled variant relationship", y = NULL, x = NULL)
plot_cases <- cases_scaled +
  cases_pooled +
  plot_layout(nrow = 1, guides = "collect") +
  plot_annotation(theme = theme(legend.position = "bottom"))
ggsave(here("output", "cases_log.png"), plot_cases)
plot_cases

```

We modelled cases attributable to each of the two variants under each assumption, with the posterior prediction shown in figure \@ref(fig:plot-cases) from the two strain model ("Combined") and the unobserved estimates for each strain. 

#### Model comparison {-}

```{r compare-loo}
# Compare LOO
models <- c("scaled", "pooled")
loo_scaled <- forecast_fits$scaled$fit[[1]]$loo()
loo_pooled <- forecast_fits$pooled$fit[[1]]$loo()
loo_comp <- as_tibble(loo_compare(loo_scaled, loo_pooled), rownames = "model") %>%
  mutate(model = recode(model, "model1" = "scaled", "model2" = "pooled"),
         across(c(elpd_diff,se_diff), round, 2)) %>%
  filter(elpd_diff != 0)

```

We explored the difference in expected predictive performance between the two models. Comparing the models on PSIS-LOO indicated an estimated difference in expected log pointwise predictive density of `r loo_comp$elpd_diff` (with a standard error of `r loo_comp$se_diff`) for the `r loo_comp$model` model compared to the `r models[!grepl(loo_comp$model, models)]` model.

```{r compare-score, include=TRUE}
# Compare model scores
scores <- map2_dfr(forecasts,
                   variant_relationships,
                   ~ summary(.x, target = "forecast", type = "cases") %>%
                     fv_score_forecast(., obs, summarise_by = "strains",
                                       metrics = NULL) %>%
                     mutate("Variant relationship" = .y))

scores <- scores %>%
  select("Variant relationship", 
         "Sharpness" = sharpness)
kable(scores)

```

### Discussion {-}

We found that transmission advantage varied depending on the choice of relationship between the two variants. We compared between a model that uses a fixed relationship between variants, against a model that allowed the relationship to vary over time.

This can be interpreted in terms of variant transmissibility compared to immune escape. If the two models show little difference in growth rate and have similar predictive performance, this suggests that increased transmissibility largely accounts for the growth of Omicron. However, if results from each model differ this might suggest transmissibility is not sufficient to explain the spread, and the advantage of Omicron is more likely to be due to immune escape. 

Modelling choices and appropriate data both limit our work.

We used an autoregressive process with daily data.

SGTF data may be a poor proxy for the Omicron variant, with Omicron reported with both positive and negative S-gene target. 

Only some laboratories are able to detect the S-gene target from PCR tests.

Biased sampling of testing for SGTF biases the growth rate upwards.


\newpage

###  Appendix: Model details and parameters {-}

#### Model details {-}

To model a single strain, we model the mean of reported cases as an order 1 autoregressive (AR(1)) process on the log scale by time unit. The model is initialised by assuming that the initial reported cases are representative with a small amount of error (2.5%). This uses an initial growth rate, where the exponential is the effective reproduction number (Rt). We scaled the reproduction number to the mean generation time, set at `r 7 * parameters$scale_r` days. The growth rate is then itself modelled as a differenced AR(1) process. We then assume a negative binomial observation model with overdispersion for reported cases.

We expanded the single strain model to explore dynamics between two strains. This model used the single strain model as a starting point with the addition of strain specific auto-regressive AR(1) variation, and a beta binomial observation process for SGTF data. Mean reported cases are again defined using a AR(1) process on the log scale for each strain and then combined for overall mean reported cases. The mean reported cases due to the variant of concern (VoC) is derived by calculating the mean proportion of cases that had the VoC for the first time point using the overall number of reported cases and the number of cases that were positive for the VoC. 

The growth rate for VoC and non-VoC cases is then modelled as a combination of an overall growth rate (as defined for the single strain model), a strain specific modifier, and an AR(1) error term post introduction. We used a weakly informative prior for a transmission advantage for the VoC vs non-VoC cases of mean `r parameters$voc_scale[1]` (standard deviation `r parameters$voc_scale[2]`), based on early work from South Africa. We defined the relationship between variants as either fixed or pooled. The fixed relationship meant the VoC differs only by the transmissibility difference to the non-VOC strain and any variation over time is shared between strains. The pooled relationship allowed the VoC to differ with dependence determined from the data. 

Finally, the mean proportion of samples that have the VoC is then estimated using the mean reported cases with the VoC and the overall mean reported cases. We assume a beta binomial observation model for the number of cases with known S gene status that are positive for the VoC with overdispersion.

#### Model parameters {-}

``` {r show-parameters}
# Display model parameters
print(parameters)
```
